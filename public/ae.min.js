"use strict";!function(){function t(t){var e=[];for(var i in t)e.push(i);e=e.sort();var o=[];e.forEach(function(e){var i=t[e];_.isObject(i)&&(i=JSON.stringify(i)),o.push(e+"="+encodeURIComponent(i))});var r=o.join("&"),n=md5(r);return n}var e={Object:{CREATE_ERROR:{errno:-1,code:"CREATE_ERROR",message:"create function should be called by a new object"},SAVE_ERROR:{errno:-2,code:"SAVE_ERROR",message:"save function should be called behind get or create"},REMOVE_ERROR:{errno:-3,code:"REMOVE_ERROR",message:"remove function should be called behind get or create"},OBJECT_ID_NOT_FIND:{errno:-4,code:"OBJECT_ID_NOT_FIND",message:"Object does not find by id or more rows"}},Hook:{BEFORE_HOOK_REJECT:{errno:-301,code:"BEFORE_HOOK_REJECT",message:"before hook reject"},AFTER_HOOK_REJECT:{errno:-302,code:"AFTER_HOOK_REJECT",message:"after hook reject"},UNCATCH_HOOK_REJECT:{errno:-303,code:"UNCATCH_HOOK_REJECT",message:"uncatch exception:"}}};angular.module("ngApi",[]).factory("$ae",["$q","$http",function(i,o){var r,n,s={mode:"DEV",appkey:"",masterKey:"",v:"0.0.1",endpoint:"http://localhost:8080/api"},c=s.endpoint,a=function(a,h){function u(t){if(void 0!==n&&_.isFunction(n))try{n({action:a,args:h,result:t})}catch(e){n({action:a,args:h,result:t,error:e})}}var d=i.defer();if(void 0!==r&&_.isFunction(r))try{if(!r({action:a,args:h}))return d.reject(e.Hook.BEFORE_HOOK_REJECT),d.promise}catch(f){var p=_.clone(e.Hook.UNCATCH_HOOK_REJECT);return p.message=p.message+f,d.reject(p),d.promise}delete h.scope;var l=s.v;if(_.isObject(a))l=a.v||l,a=a.action;else if(_.isString(a)){var v=a.indexOf("@");v>1&&(l=a.substr(v+1),a=a.substr(0,v))}var E={method:a,appkey:s.appkey,masterKey:s.masterKey,timestamp:_.now(),param:h,v:l},O=t(E);return E.sign=O,delete E.masterKey,o.post(c,E).success(function(t){0===t.errno?d.resolve(t.data):d.reject(t),u(t)}).error(function(t){d.reject(t),u(t)}),d.promise},h=function(t,e){if(!_.isString(t))throw new Error("Object Class should be String");this._t=t,this._d=e||{},this.objectId=this._d.id||void 0};h.prototype.toJson=function(){return this._d},h.prototype.print=function(){console.log("id="+this.objectId),console.log("createAt="+this._d.createAt),console.log("updateAt="+this._d.updateAt),console.log("data="+JSON.stringify(this._d))},h.prototype.set=function(t,e){return _.isObject(t)?this._d=_.extend(this._d,t):this._d[t]=e,this},h.prototype.get=function(t){return t?this._d[t]:this._d},h.prototype.getById=function(t){var e=i.defer();this.objectId=t;var o=this,r={table:this._t,id:t};return a("api.get",r).then(function(t){o._d=t,e.resolve(o)})["catch"](function(t){e.reject(t)}),e.promise},h.prototype.save=function(t){var o=i.defer();if(void 0===this.objectId)return o.reject(e.Object.SAVE_ERROR),o.promise;t&&(this._d=t),this._d.updateAt=(new Date).getTime();var r=this,n={table:this._t,condition:" id = "+this.objectId,row:this._d};return a("api.update",n).then(function(){o.resolve(r)})["catch"](function(t){o.reject(t)}),o.promise},h.prototype.remove=function(){var t=i.defer();if(void 0===this.objectId)return t.reject(e.Object.REMOVE_ERROR),t.promise;var o={table:this._t,id:this.objectId};return a("api.remove",o).then(function(){t.resolve(1)})["catch"](function(e){t.reject(e)}),t.promise},h.prototype.create=function(t){var o=i.defer();if(void 0!==this.objectId)return o.reject(e.Object.CREATE_ERROR),o.promise;t&&(this._d=t),this._d.updateAt=this._d.createAt=(new Date).getTime();var r=this,n={table:this._t,row:this._d};return a("api.create",n).then(function(t){r.objectId=t.insertId,r._d.id=r.objectId,o.resolve(r)})["catch"](function(t){o.reject(t)}),o.promise};var u=function(t){if(!_.isString(t))throw new Error("Class should be String");this._t=t,this._s="id-",this._l=100,this._k=0,this._c=" 1=1 ",this._f="*"};u.prototype.sort=function(t){return this._s=t,this},u.prototype.page=function(t,e){return this._l=e||100,this._k=(t-1)*this._l,this},u.prototype.condition=function(t){return this._c=t,this},u.prototype.and=function(t){return this._c=this._c+" and "+t,this},u.prototype.or=function(t){return this._c=this._c+" or "+t,this},u.prototype.select=function(t){return _.isString(t)&&(t=t.split(",")),_.contains(t,"id")||t.push("id"),_.contains(t,"createAt")||t.push("createAt"),_.contains(t,"updateAt")||t.push("updateAt"),t=t.join(","),this._f=t,this},u.prototype.count=function(){var t=i.defer(),e={table:this._t,condition:this._c};return a("api.count",e).then(function(e){t.resolve(e)})["catch"](function(e){t.reject(e)}),t.promise},u.prototype.findAndCount=function(){var t=i.defer(),e=this,o={table:this._t,condition:this._c,sort:this._s,limit:this._l,skip:this._k,fields:this._f};return a("api.findAndCount",o).then(function(i){var o=[];_.isEmpty(i)||_.each(i.rows,function(t){var i=new h(e._t,t);o.push(i)}),i.rows=o,t.resolve(i)})["catch"](function(e){t.reject(e)}),t.promise},u.prototype.first=function(){var t=i.defer(),e=this,o={table:this._t,condition:this._c,sort:this._s,limit:this._l,skip:this._k,fields:this._f};return a("api.first",o).then(function(i){var o;_.isArray(i)?0===i.length&&(o=new h(e._t),t.resolve(o)):_.isObject(i)&&(o=new h(e._t,i),t.resolve(o))})["catch"](function(e){t.reject(e)}),t.promise},u.prototype.find=function(){var t=i.defer(),e=this,o={table:this._t,condition:this._c,sort:this._s,limit:this._l,skip:this._k,fields:this._f};return a("api.find",o).then(function(i){var o=[];_.isEmpty(i)||_.each(i,function(t){var i=new h(e._t,t);o.push(i)}),t.resolve(o)})["catch"](function(e){t.reject(e)}),t.promise},u.prototype.clear=function(){var t=i.defer(),e={table:this._t,condition:this._c};return a("api.clear",e).then(function(e){t.resolve(e)})["catch"](function(e){t.reject(e)}),t.promise};var d=function(t){this._f=t};return d.prototype.invoke=function(t){var e=i.defer();return a(this._f,t).then(function(t){e.resolve(t)})["catch"](function(t){e.reject(t)}),e.promise},{init:function(t){t=t||{};for(var e in t)s[e]=t[e];c=s.endpoint},beforeHook:function(t){r=t},afterHook:function(t){n=t},Object:h,Query:u,Function:d}}])}();